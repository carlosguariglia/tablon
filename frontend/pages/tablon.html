<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tablón de Anuncios</title>
    <!-- Asegúrate que la ruta del CSS es correcta -->
    <link rel="stylesheet" href="/css/tablon.css">
    
</head>
<body>
    <div class="container">
        <header class="site-header">
                        <div class="site-title">
                                                <a href="https://www.facebook.com/UNMARdelplata" target="_blank" rel="noopener noreferrer" title="UNMAR en Facebook">
                                                    <img src="/assets/images/unmar_logo.jpg" alt="Logo" class="site-logo" />
                                                </a>
                                <h1>Tablón de Anuncios</h1>
                        </div>
            <div id="userHeader"></div>
            <a href="/pages/login.html" class="btn" id="loginBtn">Ir al Login</a>
        </header>

    <div id="anuncioFormContainer"></div>

        <!-- Filtros -->
        <form id="filtrosForm" class="filtros-form">
            <label>
                Desde:
                <input type="date" id="desde" name="desde">
            </label>
            <label>
                Artista:
                <input type="text" id="artista" name="artista" placeholder="Buscar por artista">
            </label>
            <label class="artist-label">
                <button type="button" id="openArtistBtn" class="btn" >Ver artista</button>
            </label>
            <label>
                Categoría:
                <select id="categoria" name="categoria">
                    <option value="">Todas</option>
                    <option value="Concierto">Concierto</option>
                    <option value="Presentacion">Presentación</option>
                    <option value="Anuncio">Anuncio</option>
                    <option value="Otros">Otros</option>
                </select>
            </label>
            <button type="submit" class="btn">Filtrar</button>
            <button type="button" id="resetBtn" class="btn">Limpiar</button>
        </form>

        <div id="loadingState" class="loading-state">
            <div class="spinner"></div>
            <p>Cargando anuncios...</p>
        </div>

        <div id="calendarioContainer" class="calendario-container"></div>

    <div id="errorState" class="error-state">
            <h3>Error al cargar anuncios</h3>
            <p id="errorMessage"></p>
            <button onclick="window.location.reload()" class="btn">Reintentar</button>
        </div>

        <!-- Pop-up -->
    <div id="popup" class="popup">
            <div class="popup-content">
                <span id="popupClose" class="popup-close">&times;</span>
                <div id="popupBody"></div>
            </div>
        </div>

        <!-- Formulario de edición de anuncio (modal) -->
                <div id="editModal" class="modal">
                    <div>
                        <span id="editModalClose">&times;</span>
            <h2>Editar anuncio</h2>
            <form id="editAnuncioForm">
              <input type="text" id="editTitulo" name="titulo" placeholder="Título" required><br>
              <textarea id="editDescripcion" name="descripcion" placeholder="Descripción" required></textarea><br>
              <input type="datetime-local" id="editFecha" name="fecha" required><br>
              <input type="text" id="editLugar" name="lugar" placeholder="Lugar" required><br>
              <input type="number" id="editPrecio" name="precio" placeholder="Precio" min="0"><br>
              <input type="text" id="editParticipantes" name="participantes" placeholder="Participantes"><br>
              <select id="editCategoria" name="categoria" required>
                <option value="Concierto">Concierto</option>
                <option value="Presentacion">Presentación</option>
                <option value="Anuncio">Anuncio</option>
                <option value="Otros">Otros</option>
              </select><br>
              <button type="submit" class="btn">Guardar cambios</button>
            </form>
            <div id="editMsg"></div>
          </div>
        </div>
    </div>

    <script>
        // Función para mostrar los anuncios en formato calendario según rango seleccionado
        function displayCalendario(anuncios, desdeStr) {
            // Convertir yyyy-mm-dd a Date
            let desde;
            if (desdeStr && /^\d{4}-\d{2}-\d{2}$/.test(desdeStr)) {
                const [yyyy, mm, dd] = desdeStr.split('-');
                desde = new Date(`${yyyy}-${mm}-${dd}T00:00:00`);
            } else {
                desde = new Date();
            }
            desde.setHours(0,0,0,0);

            const diasSemana = ['Domingo','Lunes','Martes','Miércoles','Jueves','Viernes','Sábado'];
            let dias = [];
            for(let i=0; i<7; i++) {
                const d = new Date(desde.getTime() + i*24*60*60*1000);
                dias.push({
                    fecha: new Date(d),
                    nombre: diasSemana[d.getDay()],
                    anuncios: []
                });
            }

            // Agrupar anuncios por día (comparar solo año, mes y día)
            anuncios.forEach(anuncio => {
                const fechaAnuncio = new Date(anuncio.fecha);
                dias.forEach(dia => {
                    if (
                        fechaAnuncio.getFullYear() === dia.fecha.getFullYear() &&
                        fechaAnuncio.getMonth() === dia.fecha.getMonth() &&
                        fechaAnuncio.getDate() === dia.fecha.getDate()
                    ) {
                        dia.anuncios.push(anuncio);
                    }
                });
            });

            // Limpiar el contenedor antes de crear la cuadrícula
            const container = document.getElementById('calendarioContainer');
            while (container.firstChild) container.removeChild(container.firstChild);
            const grid = document.createElement('div');
            grid.className = 'calendario-grid';
            const user = JSON.parse(localStorage.getItem('user'));
            dias.forEach(dia => {
                const col = document.createElement('div');
                col.className = 'calendario-dia';
                // Header del día
                const headerDiv = document.createElement('div');
                headerDiv.className = 'calendario-dia-header';
                headerDiv.appendChild(document.createTextNode(dia.nombre));
                headerDiv.appendChild(document.createElement('br'));
                const fechaSpan = document.createElement('span');
                fechaSpan.className = 'calendario-dia-fecha';
                const yy = String(dia.fecha.getFullYear()).slice(-2);
                const fechaArg = `${String(dia.fecha.getDate()).padStart(2,'0')}-${String(dia.fecha.getMonth()+1).padStart(2,'0')}-${yy}`;
                fechaSpan.textContent = fechaArg;
                headerDiv.appendChild(fechaSpan);
                col.appendChild(headerDiv);
                // Eventos o vacío
                if(dia.anuncios.length === 0) {
                    const vacioDiv = document.createElement('div');
                    vacioDiv.className = 'calendario-vacio';
                    vacioDiv.textContent = 'Sin eventos';
                    col.appendChild(vacioDiv);
                } else {
                    dia.anuncios.forEach(anuncio => {
                        const btn = document.createElement('button');
                        btn.className = 'calendario-anuncio-btn';
                        btn.textContent = anuncio.titulo;
                        btn.onclick = () => mostrarPopup(anuncio);
                        col.appendChild(btn);
                        // Mostrar botones solo si el usuario es el autor o admin
                        if (user && (anuncio.autor === user.name || (user.name === 'admin' && user.email === 'admin@gmail.com'))) {
                            const editBtn = document.createElement('button');
                            editBtn.textContent = 'Editar';
                            editBtn.className = 'calendario-edit-btn';
                            editBtn.onclick = () => editarAnuncio(anuncio);
                            col.appendChild(editBtn);
                            const deleteBtn = document.createElement('button');
                            deleteBtn.textContent = 'Eliminar';
                            deleteBtn.className = 'calendario-delete-btn';
                            deleteBtn.onclick = () => eliminarAnuncio(anuncio);
                            col.appendChild(deleteBtn);
                        }
                    });
                }
                grid.appendChild(col);
            });
            container.appendChild(grid);
        }

        // Función para formatear fechas en formato argentino (dd-mm-yy hh:mm)
        function formatDate(dateString) {
            if (!dateString) return 'Fecha no especificada';
            const date = new Date(dateString);
            const dd = String(date.getDate()).padStart(2, '0');
            const mm = String(date.getMonth() + 1).padStart(2, '0');
            const yy = String(date.getFullYear()).slice(-2);
            const hh = String(date.getHours()).padStart(2, '0');
            const min = String(date.getMinutes()).padStart(2, '0');
            return `${dd}-${mm}-${yy} ${hh}:${min}`;
        }

        // Pop-up para mostrar info completa
        function mostrarPopup(anuncio) {
            const popup = document.getElementById('popup');
            const body = document.getElementById('popupBody');
            // Limpiar contenido previo
            while (body.firstChild) body.removeChild(body.firstChild);

            const h2 = document.createElement('h2');
            h2.textContent = anuncio.titulo;
            body.appendChild(h2);

            const fechaP = document.createElement('p');
            fechaP.innerHTML = '<strong>Fecha:</strong> ' + formatDate(anuncio.fecha);
            body.appendChild(fechaP);

            const lugarP = document.createElement('p');
            lugarP.innerHTML = '<strong>Lugar:</strong> ';
            lugarP.appendChild(document.createTextNode(anuncio.lugar));
            body.appendChild(lugarP);

            const descP = document.createElement('p');
            descP.innerHTML = '<strong>Descripción:</strong> ';
            descP.appendChild(document.createTextNode(anuncio.descripcion));
            body.appendChild(descP);

            if (anuncio.participantes) {
                const partP = document.createElement('p');
                partP.innerHTML = '<strong>Participantes:</strong> ';
                partP.appendChild(document.createTextNode(anuncio.participantes));
                body.appendChild(partP);
            }

            const catP = document.createElement('p');
            catP.innerHTML = '<strong>Categoría:</strong> ';
            catP.appendChild(document.createTextNode(anuncio.categoria));
            body.appendChild(catP);

            const precioP = document.createElement('p');
            precioP.innerHTML = '<strong>Precio:</strong> ';
            precioP.appendChild(document.createTextNode(anuncio.precio !== null ? `$${anuncio.precio.toFixed(2)}` : 'Gratis'));
            body.appendChild(precioP);

            const autorP = document.createElement('p');
            autorP.innerHTML = '<strong>Autor:</strong> ';
            autorP.appendChild(document.createTextNode(anuncio.autor));
            body.appendChild(autorP);

            // Botón para mostrar la semana del evento en el calendario principal
            const verCalendarioBtn = document.createElement('button');
            verCalendarioBtn.className = 'btn';
            verCalendarioBtn.textContent = 'Ver en calendario';
            verCalendarioBtn.onclick = () => {
                try {
                    const d = new Date(anuncio.fecha);
                    const yyyy = d.getFullYear();
                    const mm = String(d.getMonth() + 1).padStart(2, '0');
                    const dd = String(d.getDate()).padStart(2, '0');
                    const desdeStr = `${yyyy}-${mm}-${dd}`;
                    // set the date input so the UI reflects the change
                    const desdeInput = document.getElementById('desde');
                    if (desdeInput) desdeInput.value = desdeStr;
                    // cerrar popup y pedir recarga del calendario para esa semana
                    document.getElementById('popup').style.display = 'none';
                    fetchAnuncios({ desde: desdeStr });
                } catch (e) {
                    console.error('Error al abrir calendario:', e);
                }
            };
            body.appendChild(verCalendarioBtn);

            popup.style.display = 'flex';
        }
        document.getElementById('popupClose').onclick = function() {
            document.getElementById('popup').style.display = 'none';
        };

        // Función para obtener anuncios con filtros
        async function fetchAnuncios(params = {}) {
            let url = '/api/anuncios';
            // Ya viene en formato yyyy-mm-dd desde el input type=date
            const query = Object.entries(params)
                .filter(([_, v]) => v)
                .map(([k, v]) => `${encodeURIComponent(k)}=${encodeURIComponent(v)}`)
                .join('&');
            if (query) url += `?${query}`;
            try {
                const response = await fetch(url);
                if (!response.ok) throw new Error(`Error: ${response.status}`);
                const anuncios = await response.json();
                console.log('Anuncios recibidos:', anuncios); // Log para debug
                // Usar la fecha de inicio actual para mostrar los próximos 7 días
                const desde = document.getElementById('desde').value;
                displayCalendario(anuncios, desde);
            } catch (error) {
                console.error('Error:', error);
                document.getElementById('errorState').style.display = 'block';
                document.getElementById('errorMessage').textContent = 'Error al cargar los anuncios. Por favor recarga la página.';
            } finally {
                document.getElementById('loadingState').style.display = 'none';
            }
        }

        // Mostrar nombre del usuario logueado y formulario de anuncios
        function renderUserInfoAndForm() {
            const userHeaderDiv = document.getElementById('userHeader');
            const anuncioFormContainer = document.getElementById('anuncioFormContainer');
            const loginBtn = document.getElementById('loginBtn');
            const user = JSON.parse(localStorage.getItem('user'));
            // Limpiar header y formulario
            while (userHeaderDiv.firstChild) userHeaderDiv.removeChild(userHeaderDiv.firstChild);
            while (anuncioFormContainer.firstChild) anuncioFormContainer.removeChild(anuncioFormContainer.firstChild);
            if (user) {
                // Header usuario con imagen
                const span = document.createElement('span');
                const img = document.createElement('img');
                img.src = '/Media/corchea.png';
                img.alt = 'Usuario';
                img.style.width = '28px';
                img.style.height = '28px';
                img.style.verticalAlign = 'middle';
                img.style.marginRight = '8px';
                span.appendChild(img);
                const strong = document.createElement('strong');
                strong.textContent = user.name;
                span.appendChild(strong);
                userHeaderDiv.appendChild(span);

                const showBtn = document.createElement('button');
                showBtn.id = 'showAnuncioFormBtn';
                showBtn.className = 'btn user-action-btn primary';
                showBtn.textContent = 'Crear anuncio';
                userHeaderDiv.appendChild(showBtn);

                // Menú de administración solo para admin
                if (user.is_admin) {
                    // Botón engranaje
                    const gearBtn = document.createElement('button');
                    gearBtn.className = 'btn user-action-btn primary gear';
                    // gear icon is provided via CSS ::before so no innerHTML required
                    gearBtn.style.position = 'relative';
                    userHeaderDiv.appendChild(gearBtn);

                    // Menú desplegable
                    const menu = document.createElement('div');
                    menu.className = 'admin-menu';

                    // Opción Ver auditoría
                    const auditOption = document.createElement('button');
                    auditOption.className = 'btn admin-action';
                    auditOption.textContent = 'Ver auditoría';
                    auditOption.onclick = function() {
                        window.location.href = '/pages/audit.html';
                    };
                    menu.appendChild(auditOption);

                    // Opción Gestionar artistas (admin)
                    const artistsOption = document.createElement('button');
                    artistsOption.className = 'btn admin-action';
                    artistsOption.textContent = 'Gestionar artistas';
                    artistsOption.onclick = function() {
                        window.location.href = '/pages/admin-artists.html';
                    };
                    menu.appendChild(artistsOption);

                    // Opción Adm Usuarios
                    const usersOption = document.createElement('button');
                    usersOption.className = 'btn admin-action';
                    usersOption.textContent = 'Adm Usuarios';
                    usersOption.onclick = function() {
                        window.location.href = '/pages/admin.html';
                    };
                    menu.appendChild(usersOption);

                    gearBtn.appendChild(menu);
                    gearBtn.onclick = function(e) {
                        e.stopPropagation();
                        menu.classList.toggle('open');
                    };
                    document.addEventListener('click', function() {
                        menu.classList.remove('open');
                    });
                }

                const logoutBtn = document.createElement('button');
                logoutBtn.id = 'logoutBtn';
                logoutBtn.className = 'btn user-action-btn logout';
                logoutBtn.textContent = 'Cerrar sesión';
                userHeaderDiv.appendChild(logoutBtn);

                if (loginBtn) loginBtn.style.display = 'none';
                anuncioFormContainer.style.display = 'none';

                showBtn.onclick = function() {
                    anuncioFormContainer.style.display = 'block';
                    showBtn.style.display = 'none';
                };
                logoutBtn.onclick = function() {
                    localStorage.removeItem('token');
                    localStorage.removeItem('user');
                    window.location.href = '/pages/login.html';
                };

                // Formulario de creación
                const h2 = document.createElement('h2');
                h2.textContent = 'Crear anuncio';
                anuncioFormContainer.appendChild(h2);

                const form = document.createElement('form');
                form.id = 'anuncioForm';

                const titulo = document.createElement('input');
                titulo.type = 'text';
                titulo.id = 'titulo';
                titulo.name = 'titulo';
                    titulo.placeholder = 'Título';
                    titulo.title = 'Título';
                titulo.required = true;
                form.appendChild(titulo);
                form.appendChild(document.createElement('br'));

                const descripcion = document.createElement('textarea');
                descripcion.id = 'descripcion';
                descripcion.name = 'descripcion';
                descripcion.placeholder = 'Descripción';
                descripcion.title = 'Descripción';
                descripcion.required = true;
                form.appendChild(descripcion);
                form.appendChild(document.createElement('br'));

                const fecha = document.createElement('input');
                fecha.type = 'datetime-local';
                fecha.id = 'fecha';
                fecha.name = 'fecha';
                fecha.title = 'Fecha y hora';
                fecha.required = true;
                form.appendChild(fecha);
                form.appendChild(document.createElement('br'));

                const lugar = document.createElement('input');
                lugar.type = 'text';
                lugar.id = 'lugar';
                lugar.name = 'lugar';
                lugar.placeholder = 'Lugar';
                lugar.title = 'Lugar';
                lugar.required = true;
                form.appendChild(lugar);
                form.appendChild(document.createElement('br'));

                const precio = document.createElement('input');
                precio.type = 'number';
                precio.id = 'precio';
                precio.name = 'precio';
                precio.placeholder = 'Precio';
                precio.title = 'Precio';
                precio.min = '0';
                form.appendChild(precio);
                form.appendChild(document.createElement('br'));

                                // participantes input with suggestions from existing artists
                                const participantes = document.createElement('input');
                                participantes.type = 'text';
                                participantes.id = 'participantes';
                                participantes.name = 'participantes';
                                participantes.placeholder = 'Participantes (sugerencias disponibles)';
                                participantes.title = 'Participantes';
                                participantes.setAttribute('list', 'artistsSuggest');
                                form.appendChild(participantes);
                                const dl = document.createElement('datalist');
                                dl.id = 'artistsSuggest';
                                form.appendChild(dl);

                                // Debounced fetch for artist suggestions
                                let suggestTimer = null;
                                participantes.addEventListener('input', function() {
                                    const q = this.value.trim();
                                    if (suggestTimer) clearTimeout(suggestTimer);
                                    if (!q) return;
                                    suggestTimer = setTimeout(async () => {
                                        try {
                                            const res = await fetch(`/api/artistas?name=${encodeURIComponent(q)}`);
                                            if (!res.ok) return;
                                            const data = await res.json();
                                            const list = document.getElementById('artistsSuggest');
                                            while (list.firstChild) list.removeChild(list.firstChild);
                                                                    if (data && data.matches && data.matches.length) {
                                                                        data.matches.forEach(m => {
                                                                            const opt = document.createElement('option');
                                                                            opt.value = m.name;
                                                                            list.appendChild(opt);
                                                                        });
                                                                    } else if (data && data.artist) {
                                                                        const opt = document.createElement('option'); opt.value = data.artist; list.appendChild(opt);
                                                                    } else if (data && Array.isArray(data.posts) && data.posts.length) {
                                                                        // fallback: extract participantes from posts (comma-separated) and add unique suggestions
                                                                        const seen = new Set();
                                                                        data.posts.forEach(p => {
                                                                            if (!p.participantes) return;
                                                                            // participantes might be a comma-separated string
                                                                            const parts = String(p.participantes).split(',').map(s => s.trim()).filter(Boolean);
                                                                            parts.forEach(name => {
                                                                                const n = name.replace(/\s+/g,' ').trim();
                                                                                if (n && !seen.has(n)) {
                                                                                    seen.add(n);
                                                                                    const opt = document.createElement('option'); opt.value = n; list.appendChild(opt);
                                                                                }
                                                                            });
                                                                        });
                                                                    }
                                        } catch (e) {
                                            // ignore silently
                                        }
                                    }, 300);
                                });
                form.appendChild(document.createElement('br'));

                const categoria = document.createElement('select');
                categoria.id = 'categoria';
                categoria.name = 'categoria';
                categoria.required = true;
                const opciones = ['Concierto','Presentacion','Anuncio','Otros'];
                opciones.forEach(op => {
                    const option = document.createElement('option');
                    option.value = op;
                    option.textContent = op;
                    categoria.appendChild(option);
                });
                form.appendChild(categoria);
                form.appendChild(document.createElement('br'));

                const submitBtn = document.createElement('button');
                submitBtn.type = 'submit';
                submitBtn.className = 'btn';
                submitBtn.textContent = 'Publicar anuncio';
                form.appendChild(submitBtn);

                // Botón cancelar
                const cancelBtn = document.createElement('button');
                cancelBtn.type = 'button';
                cancelBtn.className = 'btn';
                cancelBtn.textContent = 'Cerrar formulario';
                cancelBtn.classList.add('btn-cancel');
                form.appendChild(cancelBtn);

                anuncioFormContainer.appendChild(form);

                const anuncioMsg = document.createElement('div');
                anuncioMsg.id = 'anuncioMsg';
                anuncioFormContainer.appendChild(anuncioMsg);

                // Evento cancelar
                cancelBtn.onclick = function() {
                    anuncioFormContainer.style.display = 'none';
                    document.getElementById('showAnuncioFormBtn').style.display = 'inline-block';
                };

                form.onsubmit = async function(e) {
                    e.preventDefault();
                    // Obtener token y validar
                    const token = localStorage.getItem('token');
                    if (!token) {
                        anuncioMsg.textContent = 'Debes iniciar sesión para crear un anuncio.';
                        setTimeout(() => window.location.href = '/pages/login.html', 1200);
                        return;
                    }
                    // Sanitizar inputs
                    function clean(str) {
                        return String(str).trim().replace(/[<>&"']/g, '');
                    }
                    const data = {
                        titulo: clean(titulo.value),
                        descripcion: clean(descripcion.value),
                        fecha: clean(fecha.value),
                        lugar: clean(lugar.value),
                        precio: clean(precio.value),
                        categoria: clean(categoria.value),
                        participantes: clean(participantes.value)
                    };
                    try {
                        const res = await fetch('/api/anuncios', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${token}`
                            },
                            body: JSON.stringify(data)
                        });
                        if (res.status === 401) {
                            anuncioMsg.textContent = 'Sesión inválida o expirada. Redirigiendo al login...';
                            setTimeout(() => window.location.href = '/pages/login.html', 1200);
                            return;
                        }
                        if (!res.ok) {
                            const err = await res.json().catch(() => ({}));
                            throw new Error(err.message || `Error: ${res.status}`);
                        }
                        const nuevoAnuncio = await res.json();
                        console.log('Anuncio creado:', nuevoAnuncio);
                        anuncioMsg.textContent = 'Anuncio publicado con éxito.';
                        form.reset();
                        anuncioFormContainer.style.display = 'none';
                        document.getElementById('showAnuncioFormBtn').style.display = 'inline-block';
                        // Volver a cargar los anuncios
                        fetchAnuncios({ desde: document.getElementById('desde').value });
                    } catch (error) {
                        console.error('Error al crear anuncio:', error);
                        anuncioMsg.textContent = error.message || 'Error al publicar el anuncio.';
                    }
                };
            } else {
                // ...existing code...
                userHeaderDiv.innerHTML = '';
                if (loginBtn) loginBtn.style.display = 'inline-block';
                anuncioFormContainer.style.display = 'none';
            }
        }

        // Función para editar un anuncio
        let anuncioEditandoId = null;
        function editarAnuncio(anuncio) {
            anuncioEditandoId = anuncio.id;
            // Mostrar modal y rellenar datos
            const modal = document.getElementById('editModal');
            modal.style.display = 'flex';
            document.getElementById('editTitulo').value = anuncio.titulo;
            document.getElementById('editDescripcion').value = anuncio.descripcion;
            // Formatear fecha para input datetime-local
            if (anuncio.fecha) {
                const d = new Date(anuncio.fecha);
                const yyyy = d.getFullYear();
                const mm = String(d.getMonth() + 1).padStart(2, '0');
                const dd = String(d.getDate()).padStart(2, '0');
                const hh = String(d.getHours()).padStart(2, '0');
                const min = String(d.getMinutes()).padStart(2, '0');
                document.getElementById('editFecha').value = `${yyyy}-${mm}-${dd}T${hh}:${min}`;
            } else {
                document.getElementById('editFecha').value = '';
            }
            document.getElementById('editLugar').value = anuncio.lugar;
            document.getElementById('editPrecio').value = anuncio.precio || '';
            document.getElementById('editCategoria').value = anuncio.categoria;
            document.getElementById('editParticipantes').value = anuncio.participantes || '';
            document.getElementById('editMsg').textContent = '';
            // Cerrar modal
            document.getElementById('editModalClose').onclick = () => {
                modal.style.display = 'none';
            };
            // Enviar edición
            document.getElementById('editAnuncioForm').onsubmit = async function(e) {
                e.preventDefault();
                const token = localStorage.getItem('token');
                if (!token) {
                    document.getElementById('editMsg').textContent = 'Debes iniciar sesión para editar.';
                    setTimeout(() => window.location.href = '/pages/login.html', 1200);
                    return;
                }
                const user = JSON.parse(localStorage.getItem('user'));
                function clean(str) {
                    return String(str).trim().replace(/[<>&"']/g, '');
                }
                const data = {
                    titulo: clean(document.getElementById('editTitulo').value),
                    descripcion: clean(document.getElementById('editDescripcion').value),
                    fecha: clean(document.getElementById('editFecha').value),
                    lugar: clean(document.getElementById('editLugar').value),
                    precio: clean(document.getElementById('editPrecio').value),
                    categoria: clean(document.getElementById('editCategoria').value),
                    participantes: clean(document.getElementById('editParticipantes').value)
                };
                let body = data;
                if (user && user.name === 'admin' && user.email === 'admin@gmail.com') {
                    body.name = user.name;
                    body.email = user.email;
                }
                try {
                    const res = await fetch(`/api/anuncios/${anuncioEditandoId}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify(body)
                    });
                    if (res.status === 401) {
                        document.getElementById('editMsg').textContent = 'Sesión inválida o expirada. Redirigiendo al login...';
                        setTimeout(() => window.location.href = '/pages/login.html', 1200);
                        return;
                    }
                    const result = await res.json();
                    if (res.ok) {
                        document.getElementById('editMsg').textContent = 'Anuncio editado correctamente.';
                        setTimeout(() => {
                            modal.style.display = 'none';
                            fetchAnuncios();
                        }, 1200);
                    } else {
                        document.getElementById('editMsg').textContent = result.message || 'Error al editar el anuncio.';
                    }
                } catch (err) {
                    document.getElementById('editMsg').textContent = 'Error de conexión.';
                }
            };
        }

        document.getElementById('editModalClose').onclick = function() {
            document.getElementById('editModal').style.display = 'none';
        };

        // Función para eliminar un anuncio
        async function eliminarAnuncio(anuncio) {
            if (confirm('¿Seguro que quieres eliminar este anuncio?')) {
                const token = localStorage.getItem('token');
                const user = JSON.parse(localStorage.getItem('user'));
                if (!token) {
                    alert('Debes iniciar sesión para eliminar anuncios. Redirigiendo al login...');
                    setTimeout(() => window.location.href = '/pages/login.html', 1200);
                    return;
                }
                let body = {};
                // Si el usuario es admin, enviar también nombre y email
                if (user && user.name === 'admin' && user.email === 'admin@gmail.com') {
                    body.name = user.name;
                    body.email = user.email;
                }
                try {
                    const res = await fetch(`/api/anuncios/${anuncio.id}`, {
                        method: 'DELETE',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify(body)
                    });
                    if (res.status === 401) {
                        alert('Sesión inválida o expirada. Redirigiendo al login...');
                        setTimeout(() => window.location.href = '/pages/login.html', 1200);
                        return;
                    }
                    const data = await res.json();
                    alert(data.message || 'Anuncio eliminado.');
                    fetchAnuncios();
                } catch (err) {
                    alert('Error al eliminar el anuncio.');
                }
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            const hoy = new Date();
            const yyyy = hoy.getFullYear();
            const mm = String(hoy.getMonth() + 1).padStart(2, '0');
            const dd = String(hoy.getDate()).padStart(2, '0');
            const hoyStr = `${yyyy}-${mm}-${dd}`;
            document.getElementById('desde').value = hoyStr;
            // Incluir artista si ya hay valor en el input
            const artista = document.getElementById('artista') ? document.getElementById('artista').value : '';
            fetchAnuncios({ desde: hoyStr, artista });
            renderUserInfoAndForm();

            // Botón para abrir ficha del artista en nueva ventana
            const openArtistBtn = document.getElementById('openArtistBtn');
            if (openArtistBtn) {
                openArtistBtn.onclick = function() {
                    const artistaInput = document.getElementById('artista').value.trim();
                    if (!artistaInput) {
                        alert('Ingresa el nombre del artista en el campo "Artista" antes de abrir la ficha.');
                        return;
                    }
                    const url = `/pages/artist.html?name=${encodeURIComponent(artistaInput)}`;
                    window.open(url, '_blank', 'width=900,height=700');
                };
            }
        });

        document.getElementById('filtrosForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const desde = document.getElementById('desde').value;
            const artista = document.getElementById('artista').value;
            const categoria = document.getElementById('categoria').value;
            fetchAnuncios({ desde, artista, categoria });
        });

        document.getElementById('resetBtn').addEventListener('click', function() {
            const hoy = new Date();
            const yyyy = hoy.getFullYear();
            const mm = String(hoy.getMonth() + 1).padStart(2, '0');
            const dd = String(hoy.getDate()).padStart(2, '0');
            const hoyStr = `${yyyy}-${mm}-${dd}`;
            document.getElementById('desde').value = hoyStr;
            document.getElementById('categoria').value = '';
            fetchAnuncios({ desde: hoyStr });
        });
    </script>
</body>
</html>
