<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tabl√≥n de Anuncios</title>
    <link rel="stylesheet" href="../css/tablon.css">
    <style>
        /* Iconos de estado base64 para evitar errores 404 */
        .empty-state::before {
            content: "üì≠";
            font-size: 4rem;
            display: block;
        }
        .error-state::before {
            content: "‚ùå";
            font-size: 4rem;
            display: block;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Tabl√≥n de Anuncios</h1>
            <a href="../pages/login.html" class="btn">Ir al Login</a>
        </header>

        <div id="loadingState" class="state-message">
            <div class="spinner"></div>
            <p>Cargando anuncios...</p>
        </div>

        <div id="anunciosContainer" class="anuncios-container" style="display: none;"></div>

        <div id="emptyState" class="state-message empty-state" style="display: none;">
            <h3>No hay anuncios disponibles</h3>
            <p>Actualmente no hay eventos publicados.</p>
        </div>

        <div id="errorState" class="state-message error-state" style="display: none;">
            <h3>Error al cargar anuncios</h3>
            <p id="errorMessage">Por favor intenta m√°s tarde.</p>
            <button onclick="window.location.reload()" class="btn">Reintentar</button>
        </div>
    </div>

    <script>
        async function cargarAnuncios() {
            const loading = document.getElementById('loadingState');
            const container = document.getElementById('anunciosContainer');
            const emptyState = document.getElementById('emptyState');
            const errorState = document.getElementById('errorState');

            // Mostrar estado de carga
            loading.style.display = 'block';
            container.style.display = 'none';
            emptyState.style.display = 'none';
            errorState.style.display = 'none';

            try {
                const response = await fetch('/api/anuncios');
                
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.error || `Error HTTP: ${response.status}`);
                }

                const anuncios = await response.json();
                console.log('Anuncios recibidos:', anuncios);

                // Ocultar carga
                loading.style.display = 'none';

                if (!anuncios || anuncios.length === 0) {
                    emptyState.style.display = 'block';
                    return;
                }

                // Mostrar anuncios
                container.innerHTML = '';
                anuncios.forEach(anuncio => {
                    const anuncioHTML = `
                        <div class="anuncio">
                            <h3>${escapeHTML(anuncio.titulo)}</h3>
                            <div class="anuncio-meta">
                                <span>üìÖ ${formatDate(anuncio.fecha)}</span>
                                <span>üìç ${escapeHTML(anuncio.lugar)}</span>
                                <span class="anuncio-precio">${anuncio.precio ? `$${anuncio.precio.toFixed(2)}` : 'Gratis'}</span>
                                ${anuncio.autor ? `<span class="anuncio-autor">üë§ ${escapeHTML(anuncio.autor)}</span>` : ''}
                            </div>
                            <p>${escapeHTML(anuncio.descripcion || '')}</p>
                            ${anuncio.participantes ? `<p><strong>Participantes:</strong> ${escapeHTML(anuncio.participantes)}</p>` : ''}
                            <span class="categoria">üè∑Ô∏è ${escapeHTML(anuncio.categoria)}</span>
                        </div>
                    `;
                    container.insertAdjacentHTML('beforeend', anuncioHTML);
                });

                container.style.display = 'block';

            } catch (error) {
                console.error('Error al cargar anuncios:', error);
                loading.style.display = 'none';
                errorState.style.display = 'block';
                document.getElementById('errorMessage').textContent = 
                    error.message || 'Error al conectar con el servidor';
            }
        }

        function formatDate(dateString) {
            const options = { 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric',
                hour: '2-digit', 
                minute: '2-digit'
            };
            return new Date(dateString).toLocaleDateString('es-ES', options);
        }

        function escapeHTML(str) {
            return str.replace(/[&<>'"]/g, 
                tag => ({
                    '&': '&amp;',
                    '<': '&lt;',
                    '>': '&gt;',
                    "'": '&#39;',
                    '"': '&quot;'
                }[tag]));
        }

        // Iniciar cuando la p√°gina cargue
        document.addEventListener('DOMContentLoaded', cargarAnuncios);
    </script>
</body>
</html>